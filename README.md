# BRT 心率带蓝牙协议逆向工程

这个项目完成了对 BigRun Team (BRT) 心率带的蓝牙通信协议的逆向工程分析，实现了数据解析、设备控制和实时监测功能。

## 项目概述

BRT 心率带是一款支持心电图(ECG)和运动监测的可穿戴设备。通过逆向工程其蓝牙 Low Energy (BLE)通信协议，本项目实现了：

- 实时心电图数据采集
- 三轴加速度计数据获取
- 心率和 R-R 间期监测
- 设备模式控制
- 数据可视化

## 蓝牙协议分析

### 核心特征值

设备使用两个主要的 BLE 特征值进行通信：

- **通知特征值**: `F000EFE3-0451-4000-0000-00000000B000` - 用于接收设备推送的数据
- **写入特征值**: `F000EFE1-0451-4000-0000-00000000B000` - 用于向设备发送控制命令

### 数据包格式

所有数据包长度为 20 字节，基本格式如下：

```
[命令字节][子命令][有效载荷 18字节]
```

### 主要命令类型

#### 1. 配置命令 (0x0F)

- **0x60**: 运动模式配置
  - `fc0f600100...` - 启用运动模式
  - `fc0f600000...` - 读取当前配置
- **0x61**: XO 参数控制
  - `fc0f610101...` - 设置 XO 参数
- **0x62**: 采样率(SR)控制
  - `fc0f620100...` - 设置采样率参数

#### 2. 实时数据 (0x14)

- **0x06**: 心率数据

  ```
  字节0: 序号
  字节1: 运动时间
  字节2-3: 心率值 (需除以100)
  字节4-5: 步频
  字节6-7: 步数
  ```

- **0x07**: R-R 间期数据
  ```
  字节0: 序号
  字节1: 数据对数量
  字节2+: R-R间期值对
  ```

#### 3. 心电数据 (0x41)

```
字节0: [ID(4位)][UID(4位)]
字节1+: ECG原始数据 (需进行电压转换)
```

电压转换公式：`((raw_value - 10000) / 10.5) + 10000`

#### 4. 加速度数据 (0x0F 0x12)

```
字节4-5: X1轴
字节6-7: Y1轴
字节8-9: Z1轴
字节10-11: X2轴
字节12-13: Y2轴
字节14-15: Z2轴
```

### 设备模式

设备支持三种工作模式，通过 ECG/SR/XO 参数组合控制：

| 模式  | ECG | SR  | XO  | 描述                               |
| ----- | --- | --- | --- | ---------------------------------- |
| Sport | 0   | 0   | 0   | 运动模式，主要采集加速度和基础心率 |
| ECG   | 1   | 0   | 1   | 心电模式，高精度心电图采集         |
| HRV   | 0   | 1   | 1   | 心率变异性模式，R-R 间期分析       |

## 项目结构

```
brt-reverse/
├── characteristic_parser.py    # 蓝牙数据解析核心
├── connect.py                 # 设备连接和数据采集
├── set_mode.py               # 设备模式配置
├── utils.py                  # 工具函数
├── test.py                   # 测试用例
├── parsers/                  # 数据解析器模块
│   ├── ecg.py               # 心电数据解析
│   ├── gsensor.py           # 加速度数据解析
│   ├── realtime.py          # 实时数据解析
│   └── sport_model.py       # 运动模式解析
└── plots/                   # 数据可视化
    ├── plot_ecg.py         # 心电图可视化
    └── plot_acc.py         # 加速度图可视化
```

## 使用方法

### 1. 环境准备

```bash
pip install bleak numpy matplotlib
```

### 2. 设备连接

首先在 `connect.py` 中设置设备的蓝牙 MAC 地址：

```python
DEVICE_ADDRESS = "your_device_mac_address"
```

### 3. 数据采集

```bash
python connect.py
```

这将连接到 BRT 心率带并开始实时数据采集，数据会保存到 `data/` 目录。

### 4. 模式配置

```bash
python set_mode.py
```

可以在运行时切换设备工作模式（sport/ecg/hrv）。

### 5. 数据可视化

```bash
# 查看心电图数据
python plots/plot_ecg.py

# 查看加速度数据
python plots/plot_acc.py
```

### 6. 协议测试

```bash
python test.py
```

运行各种数据包的解析测试。

## 数据格式

- **ECG 数据**: 保存为 numpy 数组 (`ecg_data.npy`)
- **加速度数据**: 保存为 npz 格式 (`acc_data.npz`)，包含 x、y、z 三轴数据

## 技术特点

1. **异步 BLE 通信**: 使用 bleak 库实现跨平台蓝牙通信
2. **模块化设计**: 将不同类型的数据解析器分离，便于维护
3. **实时数据处理**: 支持实时数据流解析和存储
4. **多模式支持**: 完整支持设备的三种工作模式
5. **数据可视化**: 提供心电图和加速度数据的可视化工具

## 注意事项

- 确保设备已正确配对并在蓝牙范围内
- 某些功能可能需要设备处于特定模式
- 数据采集过程中保持设备电量充足
- 建议在测试环境中使用，避免在生产环境中运行

## 相关资源

完整的逆向工程过程和技术细节请参考：
[BigRun Team 心率带逆向工程详解](https://blog.zhelearn.com/2025/02/08/bigrun-team-heartrate-monitor-reverse-engineering/)

## 许可证

本项目仅供学习和研究使用。
